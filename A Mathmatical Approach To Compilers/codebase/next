follow the pipeline diagram in appendix 2

add conditionals support
